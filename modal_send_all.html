<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    #progressBarContainer {
      width: 100%;
      background-color: #ccc;
      border-radius: 5px;
      margin-top: 10px;
      display: none;
    }

    #progressBar {
      width: 0%;
      height: 20px;
      background-color: #4caf50;
      text-align: center;
      color: white;
      border-radius: 5px;
    }

    textarea {
      width: 100%;
      height: 150px;
      resize: vertical;
    }
  </style>
</head>
<body>
  <h2>Enviar Todos los Certificados</h2>
  <form id="paramForm" onsubmit="return false;">
    <label for="sheetUrl">URL de la Hoja de Cálculo:</label><br>
    <input type="text" id="sheetUrl" name="sheetUrl" required><br><br>

    <label for="folderUrl">URL de la Carpeta con los Certificados:</label><br>
    <input type="text" id="folderUrl" name="folderUrl" required><br><br>

    <label for="mensajeEmail">Cuerpo del Correo Electrónico:</label><br>
    <textarea id="mensajeEmail" name="mensajeEmail" placeholder="Ingrese el mensaje que se enviará por correo..." required></textarea><br><br>

    <input type="button" id="sendBtn" value="Enviar Certificados" onclick="iniciarEnvio()">
    <input type="button" id="stopBtn" value="Detener" onclick="detenerEnvio()">
  </form>

  <p id="statusMessage"></p>
  <p id="certCount"></p>

  <div id="progressBarContainer">
    <div id="progressBar">0%</div>
  </div>

  <script>
    function iniciarEnvio() {
      const sheetUrl = document.getElementById('sheetUrl').value.trim();
      const folderUrl = document.getElementById('folderUrl').value.trim();
      const mensajeEmail = (document.getElementById('mensajeEmail')?.value || "").trim(); // <= corrección segura, si no tiene un valor definido lo inicia como cadena vacía

      if (!sheetUrl || !folderUrl) {
        alert("Por favor, completa todos los campos.");
        return;
      }

      bloquearFormulario(true);
      document.getElementById('progressBarContainer').style.display = "block";
      actualizarProgreso({ porcentaje: 0, mensaje: "Preparando envío...", generados: 0, total: 0 });

      // Ejecutar función de envío en el backend
      google.script.run
        .withSuccessHandler(function(defaultBatchSize) {
          google.script.run
            .withSuccessHandler(actualizarProgreso)
            .withFailureHandler((error) => {
              alert("Error al enviar certificados: " + error.message);
              bloquearFormulario(false);
            })
            .procesarYEnviarCertificados(sheetUrl, folderUrl, defaultBatchSize, mensajeEmail); // se pasa el mensaje
        })
        .obtenerBatchSizePorDefecto();

      let progresoInterval = setInterval(() => {
        google.script.run
          .withSuccessHandler((datos) => {
            actualizarProgreso(datos);
            if (datos.porcentaje >= 100) {
              clearInterval(progresoInterval);
            }
          })
          .obtenerProgresoEnvio();
      }, 1000);
    }

    function detenerEnvio() {
      google.script.run
        .withSuccessHandler(() => {
          alert("Proceso de envío detenido.");
          bloquearFormulario(false);
        })
        .detenerEnvioCertificados();
    }

    function actualizarProgreso(datos) {
      var progressBar = document.getElementById('progressBar');
      var statusMessage = document.getElementById('statusMessage');
      var certCount = document.getElementById('certCount');

      progressBar.style.width = datos.porcentaje + "%";
      progressBar.textContent = datos.porcentaje + "%";
      statusMessage.textContent = datos.mensaje;
      certCount.textContent = `Certificados enviados: ${datos.generados} / ${datos.total}`;

      if (datos.porcentaje >= 100) {
        bloquearFormulario(false);
        progressBar.textContent = "Completado";
      }
    }

    function bloquearFormulario(bloquear) {
      document.getElementById('sheetUrl').disabled = bloquear;
      document.getElementById('folderUrl').disabled = bloquear;
      document.getElementById('mensajeEmail').disabled = bloquear;
      document.getElementById('sendBtn').disabled = bloquear;
      document.getElementById('stopBtn').disabled = !bloquear;
    }
  </script>
</body>
</html>
